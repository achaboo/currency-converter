<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¤–è²¨â†’æ—¥æœ¬å†† è‡ªå‹•æ›ç®—ãƒ„ãƒ¼ãƒ«</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <style>
      :root {
        --bg: #f4f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --line: #dbe3ee;
        --primary: #0f766e;
        --primary-hover: #0b5f58;
        --danger: #b91c1c;
        --shadow: 0 8px 22px rgba(12, 36, 62, 0.08);
      }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: sans-serif; color: var(--text); background: var(--bg); }
      .container { max-width: 1100px; margin: 0 auto; padding: 20px 16px; }
      .toolbar { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 10px; }
      input[type="text"] { border: 1px solid var(--line); border-radius: 10px; padding: 10px; width: 120px; text-transform: uppercase; }
      button { border: 0; border-radius: 10px; padding: 10px 14px; color: #fff; background: var(--primary); cursor: pointer; font-weight: 700; }
      .sync-ok { color: var(--primary); }
      .sync-err { color: var(--danger); }

      /* ===== ä¸Šéƒ¨: ã‚µãƒãƒªãƒ¼ + ãƒãƒ£ãƒ¼ãƒˆæ¨ªä¸¦ã³ ===== */
      .top-section { display: flex; gap: 16px; margin: 18px 0; align-items: stretch; }
      .summary { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); flex: 0 0 300px; min-width: 0; }
      .total-value { font-size: 2.4rem; font-weight: 800; margin: 4px 0; }
      .overview-chart { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); flex: 1; min-width: 0; display: flex; flex-direction: column; }
      .overview-chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .overview-chart-header h3 { margin: 0; font-size: 0.95rem; font-weight: 700; }
      .overview-chart-loading { text-align: center; padding: 40px 0; color: var(--muted); font-size: 0.85rem; }
      .overview-chart-container { flex: 1; position: relative; min-height: 200px; }
      .overview-chart-container canvas { width: 100% !important; height: 100% !important; }
      .legend-bar { display: flex; flex-wrap: wrap; gap: 8px 14px; margin-top: 8px; font-size: 0.75rem; color: var(--muted); }
      .legend-item { display: flex; align-items: center; gap: 4px; cursor: pointer; user-select: none; }
      .legend-item.dimmed { opacity: 0.3; }
      .legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

      @media (max-width: 700px) {
        .top-section { flex-direction: column; }
        .summary { flex: none; }
      }

      /* ===== é€šè²¨ã‚°ãƒªãƒƒãƒ‰ ===== */
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
      .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
      .delete-btn { background: transparent; border: 1px solid var(--line); color: var(--muted); padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; }
      .chart-btn { background: none; border: none; color: var(--primary); padding: 0; font-size: 0.8rem; cursor: pointer; font-weight: 600; text-decoration: underline; margin-top: 6px; display: inline-block; }

      /* ===== å€‹åˆ¥ãƒãƒ£ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
      .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
      .modal-overlay.active { display: flex; }
      .modal-content { background: var(--card); border-radius: 16px; padding: 24px; width: 92%; max-width: 600px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); position: relative; }
      .modal-close { position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 1.5rem; color: var(--muted); cursor: pointer; padding: 4px 8px; }
      .modal-title { margin: 0 0 4px 0; font-size: 1.2rem; font-weight: 700; }
      .modal-subtitle { margin: 0 0 16px 0; font-size: 0.85rem; color: var(--muted); }
      .chart-container { width: 100%; height: 260px; position: relative; }
      .chart-container canvas { width: 100% !important; height: 100% !important; }
      .chart-loading { text-align: center; padding: 60px 0; color: var(--muted); }
      .chart-error { text-align: center; padding: 40px 0; color: var(--danger); font-size: 0.9rem; }
      .chart-stats { display: flex; gap: 16px; margin-top: 12px; font-size: 0.82rem; color: var(--muted); flex-wrap: wrap; }
      .chart-stats span { white-space: nowrap; }
      .chart-stats strong { color: var(--text); }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <main class="container">
      <h1>å¤–è²¨â†’æ—¥æœ¬å†† è‡ªå‹•æ›ç®—ãƒ„ãƒ¼ãƒ«</h1>
      <section class="toolbar">
        <button id="fetchBtn" type="button">ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—</button>
        <input id="addCurrencyInput" type="text" placeholder="EUR" maxlength="6" />
        <button id="addCurrencyBtn" type="button" style="background:#334155;">è¿½åŠ </button>
      </section>

      <!-- ä¸Šéƒ¨: ã‚µãƒãƒªãƒ¼ï¼ˆå·¦ï¼‰+ é‡ã­ãƒãƒ£ãƒ¼ãƒˆï¼ˆå³ï¼‰-->
      <section class="top-section">
        <div class="summary">
          <p>å…¨é€šè²¨ã®æ—¥æœ¬å††åˆè¨ˆ</p>
          <p id="totalJpy" class="total-value">Â¥0</p>
          <p id="timestamp">å–å¾—æ—¥æ™‚: æœªå–å¾—</p>
          <p id="status"></p>
        </div>
        <div class="overview-chart">
          <div class="overview-chart-header">
            <h3>ç›´è¿‘1ã‚«æœˆã®å¤‰å‹•ç‡ (%)</h3>
          </div>
          <div class="overview-chart-container">
            <canvas id="overviewCanvas"></canvas>
          </div>
          <div id="overviewLoading" class="overview-chart-loading">ãƒãƒ£ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ä¸­...</div>
          <div class="legend-bar" id="overviewLegend"></div>
        </div>
      </section>

      <section id="currencyGrid" class="grid"></section>
    </main>

    <!-- å€‹åˆ¥ãƒãƒ£ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="chartModal" class="modal-overlay">
      <div class="modal-content">
        <button class="modal-close" id="chartClose">&times;</button>
        <h3 class="modal-title" id="chartTitle">USD/JPY</h3>
        <p class="modal-subtitle" id="chartSubtitle">ç›´è¿‘1ã‚«æœˆã®å€¤å‹•ã</p>
        <div id="chartArea"><div class="chart-loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
        <div class="chart-stats" id="chartStats"></div>
      </div>
    </div>

    <script>
      /* ========================================
       *  è¨­å®š
       * ======================================== */
      const API_URL = "https://open.exchangerate-api.com/v6/latest/JPY";
      const HISTORY_API = "https://api.frankfurter.dev/v1";
      const initialCurrencies = ["USD", "THB", "KRW", "INR", "CNY", "EUR", "VND", "PHP"];
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBm4fAHdtsf3NNlEmzUIJstPPTF2DSsGWk",
        authDomain: "currency-converter-3892e.firebaseapp.com",
        projectId: "currency-converter-3892e",
        appId: "1:631428748103:web:f16f1d9a58f2324f0eb262"
      };

      // é€šè²¨ã”ã¨ã®è‰²ï¼ˆæœ€å¤§16è‰²ã€è¶³ã‚Šãªã‘ã‚Œã°å¾ªç’°ï¼‰
      const COLORS = [
        "#2563eb", "#dc2626", "#16a34a", "#d97706", "#9333ea",
        "#0891b2", "#e11d48", "#65a30d", "#7c3aed", "#ea580c",
        "#0d9488", "#c026d3", "#4f46e5", "#ca8a04", "#059669", "#be123c"
      ];
      function getColor(i) { return COLORS[i % COLORS.length]; }

      const uid = new URLSearchParams(window.location.search).get("uid") || "anonymous";

      /* ========================================
       *  ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹
       * ======================================== */
      const state = {
        currencies: [...initialCurrencies],
        amounts: {},
        rates: {},
        lastUpdated: ""
      };

      let db, stateDocRef;
      let isRemoteUpdate = false;
      let dbInitialized = false;
      let saveTimer = null;
      let chartInstance = null;      // å€‹åˆ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨
      let overviewChart = null;      // å³ä¸Šã®é‡ã­ãƒãƒ£ãƒ¼ãƒˆç”¨
      let overviewCache = {};        // é€šè²¨ã‚³ãƒ¼ãƒ‰ â†’ {dates, values} ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      let hiddenCurrencies = new Set(); // å‡¡ä¾‹ã§ãƒˆã‚°ãƒ«éè¡¨ç¤ºä¸­ã®é€šè²¨

      /* ========================================
       *  DOM å‚ç…§
       * ======================================== */
      const totalJpyEl = document.getElementById("totalJpy");
      const timestampEl = document.getElementById("timestamp");
      const statusEl = document.getElementById("status");
      const currencyGrid = document.getElementById("currencyGrid");
      const chartModal = document.getElementById("chartModal");
      const chartTitle = document.getElementById("chartTitle");
      const chartSubtitle = document.getElementById("chartSubtitle");
      const chartArea = document.getElementById("chartArea");
      const chartStats = document.getElementById("chartStats");
      const overviewCanvas = document.getElementById("overviewCanvas");
      const overviewLoading = document.getElementById("overviewLoading");
      const overviewLegend = document.getElementById("overviewLegend");

      /* ========================================
       *  åˆè¨ˆå€¤ã®ã¿æ›´æ–°
       * ======================================== */
      function updateTotal() {
        let total = 0;
        state.currencies.forEach(code => {
          const amount = parseFloat(String(state.amounts[code] || "0").replace(/,/g, "")) || 0;
          const rate = state.rates[code] || 0;
          if (rate > 0) total += amount / rate;
        });
        totalJpyEl.textContent = `Â¥${Math.round(total).toLocaleString()}`;
        timestampEl.textContent = `å–å¾—æ—¥æ™‚: ${state.lastUpdated || "æœªå–å¾—"}`;
      }

      /* ========================================
       *  ã‚«ãƒ¼ãƒ‰1æšåˆ†ã®æ›ç®—è¡¨ç¤ºã‚’æ›´æ–°
       * ======================================== */
      function updateCardDisplay(code) {
        const infoEl = document.querySelector(`[data-info="${code}"]`);
        if (!infoEl) return;
        const amount = parseFloat(String(state.amounts[code] || "0").replace(/,/g, "")) || 0;
        const rate = state.rates[code] || 0;
        const jpy = rate > 0 ? amount / rate : 0;
        infoEl.innerHTML = `ãƒ¬ãƒ¼ãƒˆ: 1 JPY = ${rate ? rate.toLocaleString() : "-"} ${code}<br>æ›ç®—: Â¥${Math.round(jpy).toLocaleString()}`;
      }

      /* ========================================
       *  é€šè²¨ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå›½ã‚³ãƒ¼ãƒ‰ãƒ»é€šè²¨åãƒ»è£œåŠ©å˜ä½ï¼‰
       * ======================================== */
      const CURRENCY_INFO = {
        USD: { cc: "us", name: "ç±³ãƒ‰ãƒ«",         sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³ãƒˆ" },
        EUR: { cc: "eu", name: "ãƒ¦ãƒ¼ãƒ­",         sub: "1ãƒ¦ãƒ¼ãƒ­ = 100ã‚»ãƒ³ãƒˆ" },
        GBP: { cc: "gb", name: "è‹±ãƒãƒ³ãƒ‰",       sub: "1ãƒãƒ³ãƒ‰ = 100ãƒšãƒ³ã‚¹" },
        JPY: { cc: "jp", name: "æ—¥æœ¬å††",         sub: "1å†† = 100éŠ­" },
        THB: { cc: "th", name: "ã‚¿ã‚¤ãƒãƒ¼ãƒ„",     sub: "1ãƒãƒ¼ãƒ„ = 100ã‚µã‚¿ãƒ³" },
        KRW: { cc: "kr", name: "éŸ“å›½ã‚¦ã‚©ãƒ³",     sub: "ã‚¦ã‚©ãƒ³" },
        INR: { cc: "in", name: "ã‚¤ãƒ³ãƒ‰ãƒ«ãƒ”ãƒ¼",   sub: "1ãƒ«ãƒ”ãƒ¼ = 100ãƒ‘ã‚¤ã‚µ" },
        CNY: { cc: "cn", name: "ä¸­å›½å…ƒ",         sub: "1å…ƒ = 10è§’ = 100åˆ†" },
        VND: { cc: "vn", name: "ãƒ™ãƒˆãƒŠãƒ ãƒ‰ãƒ³",   sub: "ãƒ‰ãƒ³" },
        PHP: { cc: "ph", name: "ãƒ•ã‚£ãƒªãƒ”ãƒ³ãƒšã‚½", sub: "1ãƒšã‚½ = 100ã‚»ãƒ³ã‚¿ãƒœ" },
        AUD: { cc: "au", name: "è±ªãƒ‰ãƒ«",         sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³ãƒˆ" },
        CAD: { cc: "ca", name: "ã‚«ãƒŠãƒ€ãƒ‰ãƒ«",     sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³ãƒˆ" },
        CHF: { cc: "ch", name: "ã‚¹ã‚¤ã‚¹ãƒ•ãƒ©ãƒ³",   sub: "1ãƒ•ãƒ©ãƒ³ = 100ã‚µãƒ³ãƒãƒ¼ãƒ " },
        SGD: { cc: "sg", name: "ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«ãƒ‰ãƒ«", sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³ãƒˆ" },
        HKD: { cc: "hk", name: "é¦™æ¸¯ãƒ‰ãƒ«",       sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³ãƒˆ" },
        NZD: { cc: "nz", name: "NZãƒ‰ãƒ«",         sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³ãƒˆ" },
        MXN: { cc: "mx", name: "ãƒ¡ã‚­ã‚·ã‚³ãƒšã‚½",   sub: "1ãƒšã‚½ = 100ã‚»ãƒ³ã‚¿ãƒœ" },
        MYR: { cc: "my", name: "ãƒãƒ¬ãƒ¼ã‚·ã‚¢ãƒªãƒ³ã‚®ãƒƒãƒˆ", sub: "1ãƒªãƒ³ã‚®ãƒƒãƒˆ = 100ã‚»ãƒ³" },
        IDR: { cc: "id", name: "ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢ãƒ«ãƒ”ã‚¢", sub: "1ãƒ«ãƒ”ã‚¢ = 100ã‚»ãƒ³" },
        TRY: { cc: "tr", name: "ãƒˆãƒ«ã‚³ãƒªãƒ©",     sub: "1ãƒªãƒ© = 100ã‚¯ãƒ«ã‚·ãƒ¥" },
        ZAR: { cc: "za", name: "å—ã‚¢ãƒ•ãƒªã‚«ãƒ©ãƒ³ãƒ‰", sub: "1ãƒ©ãƒ³ãƒ‰ = 100ã‚»ãƒ³ãƒˆ" },
        SEK: { cc: "se", name: "ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³ã‚¯ãƒ­ãƒ¼ãƒŠ", sub: "1ã‚¯ãƒ­ãƒ¼ãƒŠ = 100ã‚ªãƒ¼ãƒ¬" },
        NOK: { cc: "no", name: "ãƒãƒ«ã‚¦ã‚§ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ", sub: "1ã‚¯ãƒ­ãƒ¼ãƒ = 100ã‚ªãƒ¼ãƒ¬" },
        DKK: { cc: "dk", name: "ãƒ‡ãƒ³ãƒãƒ¼ã‚¯ã‚¯ãƒ­ãƒ¼ãƒ", sub: "1ã‚¯ãƒ­ãƒ¼ãƒ = 100ã‚ªãƒ¼ãƒ¬" },
        PLN: { cc: "pl", name: "ãƒãƒ¼ãƒ©ãƒ³ãƒ‰ã‚ºãƒ­ãƒ", sub: "1ã‚ºãƒ­ãƒ = 100ã‚°ãƒ­ã‚·" },
        CZK: { cc: "cz", name: "ãƒã‚§ã‚³ã‚³ãƒ«ãƒŠ",   sub: "1ã‚³ãƒ«ãƒŠ = 100ãƒãƒ¬ã‚¸ãƒ¥" },
        HUF: { cc: "hu", name: "ãƒãƒ³ã‚¬ãƒªãƒ¼ãƒ•ã‚©ãƒªãƒ³ãƒˆ", sub: "ãƒ•ã‚©ãƒªãƒ³ãƒˆ" },
        ILS: { cc: "il", name: "ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«ã‚·ã‚§ã‚±ãƒ«", sub: "1ã‚·ã‚§ã‚±ãƒ« = 100ã‚¢ã‚´ãƒ©" },
        BRL: { cc: "br", name: "ãƒ–ãƒ©ã‚¸ãƒ«ãƒ¬ã‚¢ãƒ«", sub: "1ãƒ¬ã‚¢ãƒ« = 100ã‚»ãƒ³ã‚¿ãƒ¼ãƒœ" },
        RON: { cc: "ro", name: "ãƒ«ãƒ¼ãƒãƒ‹ã‚¢ãƒ¬ã‚¦", sub: "1ãƒ¬ã‚¦ = 100ãƒãƒ‹" },
        BGN: { cc: "bg", name: "ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ¬ãƒ•", sub: "1ãƒ¬ãƒ• = 100ã‚¹ãƒˆãƒ†ã‚£ãƒ³ã‚­" },
        ISK: { cc: "is", name: "ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ãƒ‰ã‚¯ãƒ­ãƒ¼ãƒŠ", sub: "ã‚¯ãƒ­ãƒ¼ãƒŠ" },
        TWD: { cc: "tw", name: "å°æ¹¾ãƒ‰ãƒ«",       sub: "1å…ƒ = 10è§’ = 100åˆ†" },
        KHR: { cc: "kh", name: "ã‚«ãƒ³ãƒœã‚¸ã‚¢ãƒªã‚¨ãƒ«", sub: "1ãƒªã‚¨ãƒ« = 100ã‚»ãƒ³" },
        MMK: { cc: "mm", name: "ãƒŸãƒ£ãƒ³ãƒãƒ¼ãƒãƒ£ãƒƒãƒˆ", sub: "1ãƒãƒ£ãƒƒãƒˆ = 100ãƒ”ãƒ£ãƒ¼" },
        LAK: { cc: "la", name: "ãƒ©ã‚ªã‚¹ã‚­ãƒ¼ãƒ—",   sub: "1ã‚­ãƒ¼ãƒ— = 100ã‚¢ãƒƒãƒˆ" },
        BND: { cc: "bn", name: "ãƒ–ãƒ«ãƒã‚¤ãƒ‰ãƒ«",   sub: "1ãƒ‰ãƒ« = 100ã‚»ãƒ³" },
        AED: { cc: "ae", name: "UAEãƒ‡ã‚£ãƒ«ãƒãƒ ",  sub: "1ãƒ‡ã‚£ãƒ«ãƒãƒ  = 100ãƒ•ã‚£ãƒ«ã‚¹" },
        SAR: { cc: "sa", name: "ã‚µã‚¦ã‚¸ãƒªãƒ¤ãƒ«",   sub: "1ãƒªãƒ¤ãƒ« = 100ãƒãƒ©ãƒ©" },
        QAR: { cc: "qa", name: "ã‚«ã‚¿ãƒ¼ãƒ«ãƒªãƒ¤ãƒ«", sub: "1ãƒªãƒ¤ãƒ« = 100ãƒ‡ã‚£ãƒ«ãƒãƒ " },
        KWD: { cc: "kw", name: "ã‚¯ã‚¦ã‚§ãƒ¼ãƒˆãƒ‡ã‚£ãƒŠãƒ¼ãƒ«", sub: "1ãƒ‡ã‚£ãƒŠãƒ¼ãƒ« = 1000ãƒ•ã‚£ãƒ«ã‚¹" },
        BHD: { cc: "bh", name: "ãƒãƒ¼ãƒ¬ãƒ¼ãƒ³ãƒ‡ã‚£ãƒŠãƒ¼ãƒ«", sub: "1ãƒ‡ã‚£ãƒŠãƒ¼ãƒ« = 1000ãƒ•ã‚£ãƒ«ã‚¹" },
        OMR: { cc: "om", name: "ã‚ªãƒãƒ¼ãƒ³ãƒªã‚¢ãƒ«", sub: "1ãƒªã‚¢ãƒ« = 1000ãƒã‚¤ã‚µ" },
        EGP: { cc: "eg", name: "ã‚¨ã‚¸ãƒ—ãƒˆãƒãƒ³ãƒ‰", sub: "1ãƒãƒ³ãƒ‰ = 100ãƒ”ã‚¢ã‚¹ãƒˆãƒ«" },
        NGN: { cc: "ng", name: "ãƒŠã‚¤ã‚¸ã‚§ãƒªã‚¢ãƒŠã‚¤ãƒ©", sub: "1ãƒŠã‚¤ãƒ© = 100ã‚³ãƒœ" },
        KES: { cc: "ke", name: "ã‚±ãƒ‹ã‚¢ã‚·ãƒªãƒ³ã‚°", sub: "1ã‚·ãƒªãƒ³ã‚° = 100ã‚»ãƒ³ãƒˆ" },
        CLP: { cc: "cl", name: "ãƒãƒªãƒšã‚½",       sub: "ãƒšã‚½" },
        COP: { cc: "co", name: "ã‚³ãƒ­ãƒ³ãƒ“ã‚¢ãƒšã‚½", sub: "1ãƒšã‚½ = 100ã‚»ãƒ³ã‚¿ãƒœ" },
        ARS: { cc: "ar", name: "ã‚¢ãƒ«ã‚¼ãƒ³ãƒãƒ³ãƒšã‚½", sub: "1ãƒšã‚½ = 100ã‚»ãƒ³ã‚¿ãƒ¼ãƒœ" },
        PEN: { cc: "pe", name: "ãƒšãƒ«ãƒ¼ã‚½ãƒ«",     sub: "1ã‚½ãƒ« = 100ã‚»ãƒ³ãƒ†ã‚£ãƒ¢" },
      };

      // CDNå›½æ——ç”»åƒã®IMGã‚¿ã‚°ã‚’è¿”ã™
      function getFlagImg(code) {
        const info = CURRENCY_INFO[code];
        if (!info) return "";
        return `<img src="https://flagcdn.com/24x18/${info.cc}.png" alt="${code}" style="width:24px;height:18px;vertical-align:middle;border-radius:2px;object-fit:cover;">`;
      }
      function rebuildGrid() {
        currencyGrid.innerHTML = "";
        state.currencies.forEach(code => {
          const card = document.createElement("div");
          card.className = "card";
          const label = getCurrencyLabel(code);
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
              <div>
                <strong style="font-size:1rem;">${getFlagImg(code)} ${code}</strong>
                <div style="font-size:0.7rem; color:#888; margin-top:2px;">${CURRENCY_INFO[code] ? CURRENCY_INFO[code].sub : ""}</div>
              </div>
              <button class="delete-btn" data-remove="${code}">å‰Šé™¤</button>
            </div>
            <div style="margin-top:10px;">
              <label style="font-size:0.8rem; color:#666;">é‡‘é¡</label>
              <input type="text" value="${state.amounts[code] || ""}" data-code="${code}" style="width:100%;">
            </div>
            <div style="margin-top:10px; font-size:0.85rem;" data-info="${code}"></div>
            <button class="chart-btn" data-chart="${code}">ğŸ“ˆ 1ã‚«æœˆãƒãƒ£ãƒ¼ãƒˆ</button>
          `;
          currencyGrid.appendChild(card);
          updateCardDisplay(code);
        });
        updateTotal();
      }

      /* ========================================
       *  ãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ã Firestore ä¿å­˜
       * ======================================== */
      function scheduleSave() {
        if (saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => saveToDB(), 500);
      }

      async function saveToDB() {
        if (!stateDocRef || isRemoteUpdate || !dbInitialized) return;
        try {
          statusEl.textContent = `ä¿å­˜ä¸­... (ID: ${uid})`;
          statusEl.className = "";
          await stateDocRef.set({
            currencies: state.currencies,
            amounts: state.amounts,
            rates: state.rates,
            lastUpdated: state.lastUpdated,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          statusEl.textContent = `âœ“ ä¿å­˜å®Œäº† (ID: ${uid})`;
          statusEl.className = "sync-ok";
        } catch (e) {
          console.error("ä¿å­˜å¤±æ•—", e);
          statusEl.textContent = "âœ— ä¿å­˜å¤±æ•—";
          statusEl.className = "sync-err";
        }
      }

      /* ========================================
       *  ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆå–å¾—
       * ======================================== */
      async function fetchRates() {
        statusEl.textContent = "ãƒ¬ãƒ¼ãƒˆå–å¾—ä¸­...";
        statusEl.className = "";
        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          const newRates = data.conversion_rates || data.rates || {};
          state.currencies.forEach(code => {
            if (newRates[code]) state.rates[code] = newRates[code];
          });
          state.lastUpdated = new Date().toLocaleString("ja-JP");
          state.currencies.forEach(code => updateCardDisplay(code));
          updateTotal();
          statusEl.textContent = "ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚";
          statusEl.className = "sync-ok";
          await saveToDB();
        } catch (e) {
          statusEl.textContent = "ãƒ¬ãƒ¼ãƒˆå–å¾—å¤±æ•—ã€‚";
          statusEl.className = "sync-err";
        }
      }

      /* ========================================
       *  â˜… å³ä¸Šã®é‡ã­ãƒãƒ£ãƒ¼ãƒˆï¼ˆå¤‰å‹•ç‡ãƒ™ãƒ¼ã‚¹ï¼‰
       * ======================================== */
      function formatDate(d) {
        return d.toISOString().split("T")[0];
      }

      // Frankfurter APIå¯¾å¿œé€šè²¨ï¼ˆJPYä»¥å¤–ï¼‰
      const frankfurterSupported = new Set([
        "AUD","BGN","BRL","CAD","CHF","CNY","CZK","DKK","EUR","GBP",
        "HKD","HUF","IDR","ILS","INR","ISK","KRW","MXN","MYR","NOK",
        "NZD","PHP","PLN","RON","SEK","SGD","THB","TRY","USD","ZAR"
      ]);

      async function fetchHistoryForCurrency(code) {
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å†åˆ©ç”¨
        if (overviewCache[code]) return overviewCache[code];
        if (!frankfurterSupported.has(code)) return null;

        const end = new Date();
        const start = new Date();
        start.setMonth(start.getMonth() - 1);
        const url = `${HISTORY_API}/${formatDate(start)}..${formatDate(end)}?base=JPY&symbols=${code}`;

        try {
          const res = await fetch(url);
          if (!res.ok) return null;
          const data = await res.json();
          if (!data.rates || Object.keys(data.rates).length === 0) return null;

          const dates = Object.keys(data.rates).sort();
          const jpyRates = dates.map(d => {
            const r = data.rates[d][code];
            return r > 0 ? 1 / r : null;
          });

          // å¤‰å‹•ç‡ï¼ˆ%ï¼‰ã«å¤‰æ›: åˆæ—¥ã‚’0%ã¨ã™ã‚‹
          const base = jpyRates[0];
          const pctValues = jpyRates.map(v => v !== null ? ((v - base) / base) * 100 : null);

          const result = { dates, pctValues, jpyRates };
          overviewCache[code] = result;
          return result;
        } catch (e) {
          console.error(`å±¥æ­´å–å¾—å¤±æ•—: ${code}`, e);
          return null;
        }
      }

      async function buildOverviewChart() {
        overviewLoading.style.display = "block";
        overviewCanvas.style.display = "none";

        // å…¨é€šè²¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦åˆ—å–å¾—
        const results = await Promise.all(
          state.currencies.map(async code => {
            const data = await fetchHistoryForCurrency(code);
            return { code, data };
          })
        );

        // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿
        const validResults = results.filter(r => r.data !== null);

        if (validResults.length === 0) {
          overviewLoading.textContent = "ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãªã—";
          overviewLegend.innerHTML = "";
          return;
        }

        // å…±é€šã®æ—¥ä»˜ãƒ©ãƒ™ãƒ«ï¼ˆæœ€é•·ã®ã‚‚ã®ã‚’ä½¿ç”¨ï¼‰
        let longestDates = [];
        validResults.forEach(r => {
          if (r.data.dates.length > longestDates.length) longestDates = r.data.dates;
        });
        const labels = longestDates.map(d => {
          const [, m, day] = d.split("-");
          return `${parseInt(m)}/${parseInt(day)}`;
        });

        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆ
        const datasets = validResults.map((r, i) => {
          const colorIdx = state.currencies.indexOf(r.code);
          const color = getColor(colorIdx >= 0 ? colorIdx : i);
          const isHidden = hiddenCurrencies.has(r.code);

          // æ—¥ä»˜ã‚’åˆã‚ã›ã¦ãƒãƒƒãƒ”ãƒ³ã‚°
          const dataMap = {};
          r.data.dates.forEach((d, j) => { dataMap[d] = r.data.pctValues[j]; });
          const alignedData = longestDates.map(d => dataMap[d] ?? null);

          return {
            label: r.code,
            data: alignedData,
            borderColor: color,
            backgroundColor: "transparent",
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 4,
            pointHoverBackgroundColor: color,
            borderWidth: 2,
            hidden: isHidden
          };
        });

        overviewLoading.style.display = "none";
        overviewCanvas.style.display = "block";

        if (overviewChart) overviewChart.destroy();

        const ctx = overviewCanvas.getContext("2d");
        overviewChart = new Chart(ctx, {
          type: "line",
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y !== null ? ctx.parsed.y.toFixed(2) : "-"}%`
                }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { maxTicksLimit: 7, font: { size: 10 } }
              },
              y: {
                grid: { color: "#eee" },
                ticks: {
                  font: { size: 10 },
                  callback: v => v.toFixed(1) + "%"
                }
              }
            },
            interaction: { intersect: false, mode: "index" }
          }
        });

        // ã‚«ã‚¹ã‚¿ãƒ å‡¡ä¾‹ã®æ§‹ç¯‰
        buildOverviewLegend(validResults);
      }

      function buildOverviewLegend(validResults) {
        overviewLegend.innerHTML = "";
        validResults.forEach((r, i) => {
          const colorIdx = state.currencies.indexOf(r.code);
          const color = getColor(colorIdx >= 0 ? colorIdx : i);
          const isHidden = hiddenCurrencies.has(r.code);

          const item = document.createElement("span");
          item.className = `legend-item${isHidden ? " dimmed" : ""}`;
          item.innerHTML = `<span class="legend-dot" style="background:${color}"></span>${r.code}`;
          item.addEventListener("click", () => {
            if (hiddenCurrencies.has(r.code)) {
              hiddenCurrencies.delete(r.code);
            } else {
              hiddenCurrencies.add(r.code);
            }
            // Chart.jsã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ãƒˆã‚°ãƒ«
            if (overviewChart) {
              const dsIndex = overviewChart.data.datasets.findIndex(ds => ds.label === r.code);
              if (dsIndex >= 0) {
                overviewChart.data.datasets[dsIndex].hidden = hiddenCurrencies.has(r.code);
                overviewChart.update();
              }
            }
            item.classList.toggle("dimmed");
          });
          overviewLegend.appendChild(item);
        });

        // éå¯¾å¿œé€šè²¨ã‚’è–„ãè¡¨ç¤º
        state.currencies.forEach(code => {
          if (!frankfurterSupported.has(code)) {
            const item = document.createElement("span");
            item.className = "legend-item dimmed";
            item.innerHTML = `<span class="legend-dot" style="background:#ccc"></span>${code} (éå¯¾å¿œ)`;
            overviewLegend.appendChild(item);
          }
        });
      }

      /* ========================================
       *  å€‹åˆ¥ãƒãƒ£ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
       * ======================================== */
      async function showChart(code) {
        chartModal.classList.add("active");
        chartTitle.textContent = `${code} / JPY`;
        chartSubtitle.textContent = "ç›´è¿‘1ã‚«æœˆã®å€¤å‹•ã";
        chartArea.innerHTML = `<div class="chart-loading">èª­ã¿è¾¼ã¿ä¸­...</div>`;
        chartStats.innerHTML = "";

        const end = new Date();
        const start = new Date();
        start.setMonth(start.getMonth() - 1);

        const url = `${HISTORY_API}/${formatDate(start)}..${formatDate(end)}?base=JPY&symbols=${code}`;
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`API error: ${res.status}`);
          const data = await res.json();

          if (!data.rates || Object.keys(data.rates).length === 0) {
            chartArea.innerHTML = `<div class="chart-error">ã“ã®é€šè²¨ï¼ˆ${code}ï¼‰ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚<br>Frankfurter API ãŒå¯¾å¿œã—ã¦ã„ãªã„é€šè²¨ã§ã™ã€‚</div>`;
            return;
          }

          const dates = Object.keys(data.rates).sort();
          const rateValues = dates.map(d => {
            const r = data.rates[d][code];
            return r > 0 ? 1 / r : null;
          });

          const validRates = rateValues.filter(v => v !== null);
          const minRate = Math.min(...validRates);
          const maxRate = Math.max(...validRates);
          const firstRate = validRates[0];
          const lastRate = validRates[validRates.length - 1];
          const change = lastRate - firstRate;
          const changePct = ((change / firstRate) * 100).toFixed(2);
          const changeColor = change >= 0 ? "var(--primary)" : "var(--danger)";
          const changeSign = change >= 0 ? "+" : "";
          const decimals = lastRate >= 10 ? 2 : lastRate >= 1 ? 3 : 4;

          chartStats.innerHTML = `
            <span>å§‹å€¤: <strong>${firstRate.toFixed(decimals)} å††</strong></span>
            <span>çµ‚å€¤: <strong>${lastRate.toFixed(decimals)} å††</strong></span>
            <span>å®‰å€¤: <strong>${minRate.toFixed(decimals)} å††</strong></span>
            <span>é«˜å€¤: <strong>${maxRate.toFixed(decimals)} å††</strong></span>
            <span>å¤‰å‹•: <strong style="color:${changeColor}">${changeSign}${changePct}%</strong></span>
          `;

          chartArea.innerHTML = `<div class="chart-container"><canvas id="rateChart"></canvas></div>`;
          const ctx = document.getElementById("rateChart").getContext("2d");
          if (chartInstance) chartInstance.destroy();

          const labels = dates.map(d => {
            const [, m, day] = d.split("-");
            return `${parseInt(m)}/${parseInt(day)}`;
          });

          chartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [{
                label: `1 ${code} = ? JPY`,
                data: rateValues,
                borderColor: change >= 0 ? "#0f766e" : "#b91c1c",
                backgroundColor: change >= 0 ? "rgba(15,118,110,0.08)" : "rgba(185,28,28,0.08)",
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: change >= 0 ? "#0f766e" : "#b91c1c",
                borderWidth: 2.5
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: { callbacks: { label: ctx => `${ctx.parsed.y.toFixed(decimals)} å††` } }
              },
              scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 7, font: { size: 11 } } },
                y: { grid: { color: "#eee" }, ticks: { font: { size: 11 }, callback: v => v.toFixed(decimals) } }
              },
              interaction: { intersect: false, mode: "index" }
            }
          });
        } catch (e) {
          console.error("ãƒãƒ£ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:", e);
          chartArea.innerHTML = `<div class="chart-error">ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ã“ã®é€šè²¨ã¯ Frankfurter API ã«å¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</div>`;
        }
      }

      function closeChart() {
        chartModal.classList.remove("active");
        if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
      }
      document.getElementById("chartClose").addEventListener("click", closeChart);
      chartModal.addEventListener("click", e => { if (e.target === chartModal) closeChart(); });

      /* ========================================
       *  onSnapshot: ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡
       * ======================================== */
      let prevCurrenciesJson = "";

      function handleSnapshot(doc) {
        isRemoteUpdate = true;

        if (!doc.exists) {
          dbInitialized = true;
          saveToDB();
          isRemoteUpdate = false;
          return;
        }

        const data = doc.data();
        const newCurrencies = data.currencies || [...initialCurrencies];
        const currenciesChanged = JSON.stringify(newCurrencies) !== prevCurrenciesJson;

        state.currencies = newCurrencies;
        state.rates = data.rates || {};
        state.lastUpdated = data.lastUpdated || "";

        const activeCode = document.activeElement?.dataset?.code || null;
        const remoteAmounts = data.amounts || {};

        state.currencies.forEach(code => {
          if (code !== activeCode) {
            state.amounts[code] = remoteAmounts[code] || "";
          }
        });

        if (!dbInitialized) {
          dbInitialized = true;
          rebuildGrid();
          statusEl.textContent = `âœ“ ä¿å­˜å®Œäº† (ID: ${uid})`;
          statusEl.className = "sync-ok";
          prevCurrenciesJson = JSON.stringify(state.currencies);
          // åˆå›: é‡ã­ãƒãƒ£ãƒ¼ãƒˆã‚’æ§‹ç¯‰
          buildOverviewChart();
        } else {
          state.currencies.forEach(code => {
            if (code === activeCode) return;
            const inputEl = document.querySelector(`input[data-code="${code}"]`);
            if (inputEl) inputEl.value = state.amounts[code] || "";
          });
          const currentCards = currencyGrid.querySelectorAll("[data-code]");
          const currentCodes = Array.from(currentCards).map(el => el.dataset.code);
          if (JSON.stringify(currentCodes) !== JSON.stringify(state.currencies)) {
            rebuildGrid();
          } else {
            state.currencies.forEach(code => updateCardDisplay(code));
            updateTotal();
          }
          // é€šè²¨ãƒªã‚¹ãƒˆãŒå¤‰ã‚ã£ãŸã‚‰é‡ã­ãƒãƒ£ãƒ¼ãƒˆã‚’å†æ§‹ç¯‰
          if (currenciesChanged) {
            prevCurrenciesJson = JSON.stringify(state.currencies);
            buildOverviewChart();
          }
        }

        isRemoteUpdate = false;
      }

      /* ========================================
       *  åˆæœŸåŒ–
       * ======================================== */
      function init() {
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        db = firebase.firestore();
        stateDocRef = db.collection("fxStates").doc(uid);
        rebuildGrid();
        stateDocRef.onSnapshot(handleSnapshot, err => {
          console.error("onSnapshot ã‚¨ãƒ©ãƒ¼:", err);
          statusEl.textContent = "åŒæœŸã‚¨ãƒ©ãƒ¼";
          statusEl.className = "sync-err";
          dbInitialized = true;
        });
      }

      /* ========================================
       *  ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
       * ======================================== */
      document.getElementById("fetchBtn").addEventListener("click", fetchRates);

      document.getElementById("addCurrencyBtn").addEventListener("click", () => {
        const input = document.getElementById("addCurrencyInput");
        const code = input.value.trim().toUpperCase();
        if (code && !state.currencies.includes(code)) {
          state.currencies.push(code);
          input.value = "";
          rebuildGrid();
          scheduleSave();
          // é€šè²¨è¿½åŠ  â†’ é‡ã­ãƒãƒ£ãƒ¼ãƒˆå†æ§‹ç¯‰
          buildOverviewChart();
        }
      });

      currencyGrid.addEventListener("input", e => {
        if (e.target.dataset.code) {
          const code = e.target.dataset.code;
          state.amounts[code] = e.target.value;
          updateCardDisplay(code);
          updateTotal();
          scheduleSave();
        }
      });

      currencyGrid.addEventListener("click", e => {
        const removeCode = e.target.dataset.remove;
        if (removeCode) {
          state.currencies = state.currencies.filter(c => c !== removeCode);
          delete state.amounts[removeCode];
          rebuildGrid();
          scheduleSave();
          // é€šè²¨å‰Šé™¤ â†’ é‡ã­ãƒãƒ£ãƒ¼ãƒˆå†æ§‹ç¯‰
          buildOverviewChart();
          return;
        }
        const chartCode = e.target.dataset.chart;
        if (chartCode) showChart(chartCode);
      });

      init();
    </script>
  </body>
</html>
