<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>外貨→日本円 自動換算ツール</title>
    <style>
      :root {
        --bg: #f4f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --line: #dbe3ee;
        --primary: #0f766e;
        --primary-hover: #0b5f58;
        --danger: #b91c1c;
        --shadow: 0 8px 22px rgba(12, 36, 62, 0.08);
      }
      * { box-sizing: border-box; }
      body { margin: 0; font-family: sans-serif; color: var(--text); background: var(--bg); }
      .container { max-width: 980px; margin: 0 auto; padding: 20px 16px; }
      .toolbar { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 10px; }
      input[type="text"] { border: 1px solid var(--line); border-radius: 10px; padding: 10px; width: 120px; text-transform: uppercase; }
      button { border: 0; border-radius: 10px; padding: 10px 14px; color: #fff; background: var(--primary); cursor: pointer; font-weight: 700; }
      .summary { margin: 18px 0; background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: var(--shadow); }
      .total-value { font-size: 2.4rem; font-weight: 800; margin: 4px 0; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
      .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
      .delete-btn { background: transparent; border: 1px solid #fecaca; color: var(--danger); padding: 4px 8px; border-radius: 6px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <main class="container">
      <h1>外貨→日本円 自動換算ツール</h1>
      <section class="toolbar">
        <button id="fetchBtn" type="button">為替レート取得</button>
        <input id="addCurrencyInput" type="text" placeholder="EUR" maxlength="6" />
        <button id="addCurrencyBtn" type="button" style="background:#334155;">追加</button>
      </section>
      <section class="summary">
        <p>全通貨の日本円合計</p>
        <p id="totalJpy" class="total-value">¥0</p>
        <p id="timestamp">取得日時: 未取得</p>
        <p id="status"></p>
      </section>
      <section id="currencyGrid" class="grid"></section>
    </main>

    <script>
      const API_URL = "https://open.exchangerate-api.com/v6/latest/JPY";
      const initialCurrencies = ["USD", "THB", "KRW", "VND", "PHP"];
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBm4fAHdtsf3NNlEmzUIJstPPTF2DSsGWk",
        authDomain: "currency-converter-3892e.firebaseapp.com",
        projectId: "currency-converter-3892e",
        appId: "1:631428748103:web:f16f1d9a58f2324f0eb262"
      };

      const uid = new URLSearchParams(window.location.search).get("uid") || "anonymous";
      const state = { currencies: [...initialCurrencies], amounts: {}, rates: {}, lastUpdated: "" };
      let db, stateDocRef, isRemoteUpdate = false;

      const totalJpyEl = document.getElementById("totalJpy");
      const timestampEl = document.getElementById("timestamp");
      const statusEl = document.getElementById("status");
      const currencyGrid = document.getElementById("currencyGrid");

      // UI更新
      function updateUI() {
        currencyGrid.innerHTML = "";
        let total = 0;
        state.currencies.forEach(code => {
          const amount = parseFloat(String(state.amounts[code] || "0").replace(/,/g, "")) || 0;
          const rate = state.rates[code] || 0;
          const jpy = rate > 0 ? amount / rate : 0;
          total += jpy;

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
              <strong>${code}</strong>
              ${!initialCurrencies.includes(code) ? `<button class="delete-btn" data-remove="${code}">削除</button>` : ""}
            </div>
            <div style="margin-top:10px;">
              <label style="font-size:0.8rem; color:#666;">金額</label>
              <input type="text" value="${state.amounts[code] || ""}" data-code="${code}" style="width:100%;">
            </div>
            <div style="margin-top:10px; font-size:0.85rem;">
              レート: 1 JPY = ${rate.toLocaleString() || "-"} ${code}<br>
              換算: ¥${Math.round(jpy).toLocaleString()}
            </div>
          `;
          currencyGrid.appendChild(card);
        });
        totalJpyEl.textContent = `¥${Math.round(total).toLocaleString()}`;
        timestampEl.textContent = `取得日時: ${state.lastUpdated || "未取得"}`;
      }

      // Firestore保存
      async function saveToDB() {
        if (!stateDocRef || isRemoteUpdate) return;
        try {
          await stateDocRef.set({
            currencies: state.currencies,
            amounts: state.amounts,
            rates: state.rates,
            lastUpdated: state.lastUpdated,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        } catch (e) { console.error("保存失敗", e); }
      }

      // レート取得
      async function fetchRates() {
        statusEl.textContent = "レート取得中...";
        try {
          const res = await fetch(API_URL);
          const data = await res.json();
          const newRates = data.conversion_rates || data.rates || {};
          state.currencies.forEach(code => { if (newRates[code]) state.rates[code] = newRates[code]; });
          state.lastUpdated = new Date().toLocaleString("ja-JP");
          statusEl.textContent = "レートを更新しました。";
          updateUI();
          saveToDB(); // ここでレートも保存！
        } catch (e) { statusEl.textContent = "レート取得失敗。"; }
      }

      // 初期化と同期
      function init() {
        if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
        db = firebase.firestore();
        stateDocRef = db.collection("fxStates").doc(uid);

        stateDocRef.onSnapshot(doc => {
          if (!doc.exists) {
            saveToDB();
            return;
          }
          const data = doc.data();
          isRemoteUpdate = true;
          state.currencies = data.currencies || state.currencies;
          state.amounts = data.amounts || {};
          state.rates = data.rates || {};
          state.lastUpdated = data.lastUpdated || "";
          updateUI();
          isRemoteUpdate = false;
          statusEl.textContent = `同期中 (ID: ${uid})`;
        });
      }

      // イベントリスナー
      document.getElementById("fetchBtn").addEventListener("click", fetchRates);
      document.getElementById("addCurrencyBtn").addEventListener("click", () => {
        const input = document.getElementById("addCurrencyInput");
        const code = input.value.trim().toUpperCase();
        if (code && !state.currencies.includes(code)) {
          state.currencies.push(code);
          input.value = "";
          updateUI();
          saveToDB();
        }
      });
      currencyGrid.addEventListener("input", e => {
        if (e.target.dataset.code) {
          state.amounts[e.target.dataset.code] = e.target.value;
          updateUI();
          saveToDB();
        }
      });
      currencyGrid.addEventListener("click", e => {
        const code = e.target.dataset.remove;
        if (code) {
          state.currencies = state.currencies.filter(c => c !== code);
          delete state.amounts[code];
          updateUI();
          saveToDB();
        }
      });

      init();
    </script>
  </body>
</html>
